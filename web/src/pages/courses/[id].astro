--- 
export const prerender = false; // 이 페이지는 빌드 시점에 미리 렌더링되지 않습니다. (SSR)

import { marked } from "marked";
import DefaultLayout from "@/layouts/DefaultLayout.astro";
import ImageSlider from "@/components/client/ImageSlider";
import type { CourseDetailSchemaResponse } from "@/types/responses/course-detail";
import CourseIntervalDetail from "@/components/client/CourseIntervalDetail";
import { COURSE_DIFFICULTY_COLORS } from "@/vars/colors";
import { minutesToKoreanDuration } from "@/lib/string-mapper";


const { id } = Astro.params;


let isNotFound = false;

const course: CourseDetailSchemaResponse | null = await fetch(`${import.meta.env.API_ENDPOINT}/v1/courses/${id}`).then(async (res) => {
    if (res.ok) {
        return res.json() as Promise<CourseDetailSchemaResponse>;
    } else {
        if (res.status === 404) {
            isNotFound = true;
            Astro.response.status = 404; // Set 404 status for the page
            return null;
        }
        console.error(`Failed to fetch course: ${res.status} ${res.statusText}`);
        return null;
    }
}).catch((err) => {
    console.error("Fetch error:", err);
    return null;
});

let mainAddress;
if (course?.roadAddresses) {
    mainAddress = course.roadAddresses[0];
} else if (course?.loadAddresses) {
    mainAddress = course?.loadAddresses[0];
} else {
    mainAddress = "주소 알 수 없음"
}

const NaverMapsAPIClient = import.meta.env.NAVER_MAPS_API_CLIENT;

const htmlDescription = course?.description ? marked.parse(course.description) : "";

const difficultyBackgroundColor = course ? COURSE_DIFFICULTY_COLORS[course.difficulty.level] : "#CCCCCC";
--- 

<DefaultLayout>
    <!-- Naver Maps API Script -->
    <script type="text/javascript" src=`https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${NaverMapsAPIClient}`></script>


    <!-- 상단 소개 부분 -->
    <div class="text-center mb-6">
        <h2>{course?.name}</h2>
        <p>{mainAddress}</p>
    </div>

    <!-- 난이도 / 코스 길이 / 쇼요시간 -->
    <div class="flex justify-center gap-4 mb-6">
        <div class="px-4 py-2 rounded-lg" style={`background-color: ${difficultyBackgroundColor}; color: white;`}>
            <p class="font-bold">Lv. {course?.difficulty?.level} | {course?.difficulty?.code}</p>
            <p class="text-sm">{course?.difficulty?.name}</p>
        </div>
        <div class="bg-gray-100 px-4 py-2 rounded-lg">
            <p class="text-sm">총 길이</p>
            <p class="font-bold">{course?.length} km</p>
        </div>
        <div class="bg-gray-100 px-4 py-2 rounded-lg">
            <p class="text-sm">소요 시간</p>
            <p class="font-bold">{minutesToKoreanDuration(course?.duration || 0)}</p>
        </div>
    </div>

    <!-- 코스 이미지 슬라이더 -->
    {course?.images && course.images.length > 0 && (
        <ImageSlider client:load images={course.images} className="max-w-[800px] mx-auto" />
    )}

    <!-- 코스 설명 글상자 -->
    <div class="my-10 p-5 border text-left prose" set:html={htmlDescription} />
    
    <!-- 코스 구간 세부정보  -->
    <CourseIntervalDetail courseId={course?.id} client:load />


    <!-- 데이터를 못찾았을 경우 -->
    {isNotFound && (
        <script>
            alert("코스를 찾을 수 없습니다."); // "Course not found!" in Korean
            window.location.href = "/courses";
        </script>
    )}

    <!-- 기타 알수없는 에러 발생 시 -->
    {!isNotFound && (course === null) && (
        <script>
            alert("알 수 없는 에러가 발생했어요."); // "Course not found!" in Korean
            window.location.href = "/courses";
        </script>
    )}
</DefaultLayout>
